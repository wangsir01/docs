
# 技术说｜Confluence远程代码执行漏洞(setup-restore)分析 CVE-2023-22518

原创 A.R.

[↓↓↓](javascript:)  
  
长亭安全观察  
  
[↑↑↑](javascript:)

*2023-11-21 11:00* *发表于北京*

收录于合集 #长亭技术说 1个

![图片](assets/1700545045-2c1f7b9d67189ea60f1193f00ef78395.gif)

  

**目录**

  

**一、环境搭建  
**

**二、漏洞分析**

**1\. Confluence鉴权逻辑**

**2\. 请求头X-Atlassian-Token**

**3\. holderAware.validate验证**

**4\. SetupRestoreAction处理逻辑**

**三、漏洞利用**

  

**引言**

  

未经身份验证的远程攻击者通过构造恶意请求可在一定程度绕过目标系统身份验证，并通过后台接口获得接管服务器的权限，最终可实现远程代码执行，由于攻击者无法泄露任何系统数据，因此不会影响机密性；但该漏洞利用会导致Confluence数据清空，对数据完整性产生不可逆的影响。

  

**受影响版本**

-   Atlassianconfluence<7.19.16
    
-   Atlassianconfluence<8.3.4
    
-   Atlassianconfluence<8.4.4
    
-   Atlassianconfluence<8.5.3
    
-   Atlassianconfluence<8.6.1
    

  

**不受影响版本**

-   Atlassianconfluence>=7.19.16
    
-   Atlassianconfluence>=<8.3.4
    
-   Atlassianconfluence>=8.4.4
    
-   Atlassianconfluence>=8.5.3
    
-   Atlassianconfluence>=8.6.1
    

  

**一、环境搭建**

  

这里使用docker搭建，环境变量添加调试idea调试端口，这里的版本是7.13.6。

![图片](assets/1700545045-dcd6e374121d39515ecdc734f1487de6.png)

  

安装时需要去官网生成license。

  

**二、漏洞分析**

  

后台管理中存在一个备份与恢复功能。

  

![图片](assets/1700545045-726e57f675c803710120d09511a145fa.png)

  

允许上传文件，并从文件中导入Confluence数据。  

  

对应的路由是/admin/restore.action，需要进行鉴权。

  

本次漏洞的入口就是namespace为json的一系列接口，可以绕过鉴权，同样可以进入restore.action，这里给出poc。

  

![图片](assets/1700545045-307d4c3bcd9607056fca29d71b94bebb.png)

  

  

  

****1\. Confluence鉴权逻辑****

  

  

![图片](assets/1700545045-aa09575c14941327fd18d7c73da5fa1f.png)

  

这是Struts框架的处理流程，confluence的鉴权主要是用两个Interceptor实现的  

WebSudoInterceptor、PermissionCheckInterceptor。

首先触发的是PermissionCheckInterceptor。

  

![图片](assets/1700545045-f89c0b6b40fc0e15772e3c652af37d59.png)

  

通过调用confluenceAction.isPermitted方法来进行鉴权，这里我们传入的是SetupRestoreAction。

  

![图片](assets/1700545045-09aa8ed0c32c16e690972966fd82fd32.png)

  

此处重写了isPermitted方法，返回始终为true。  

  

对于没有重写这个方法的action，会进入其父类

com.atlassian.confluence.core.ConfluenceActionSupport#isPermitted。

  

![图片](assets/1700545045-159302c085d40599bd2295ecbaedfc6d.png)

  

这里可以通过设置skipAccessCheck=true来绕过鉴权。

  

后续再继续跟进PermissionCheckInterceptor。

  

![图片](assets/1700545045-b4691c58e5b24b193d0ff8a0a61b11cc.png)

  

在WebSudoInterceptor#intercept中会对请求的uri，类名，方法名进行校验，matches方法的实现逻辑如下，如果请求的namespace为admin则需要二次认证。

  

![图片](assets/1700545045-1aa845d77d8c58fbc220e73d397edfba.png)

  

原本初始化的恢复安装请求的uri是/setup/setup-restore.action，这个uri会在 com.atlassian.confluence.setup.actions.SetupCheckInterceptor#intercept被拦住，可以参考CVE- 2023-22515。  

  

我们如果在后台中恢复安装则会请求/admin/restore.action，但admin这个namespace明显会在WebSudoInterceptor#intercept被拦截。

  

那我们利用json这个namespace是如何进行绕过的呢？可以在xwork.xml中找到答案。

  

![图片](assets/1700545045-0ced956dfb97117ff19464788e8a2e7c.png)

  

json这个namespace是继承admin的，而admin又是继承setup的，所以使用json这个命名空间既可以访问到setup-restore.action，又可以绕过WebSudoInterceptor中的二次认证，这也是本次漏洞的核心所在。  

  

  

****2\. 请求头X-Atlassian-Token****

  

  

设置X-Atlassian-Token: no-check，关键逻辑位于  

com.atlassian.xwork.interceptors.XsrfTokenInterceptor#isOverrideHeaderPresent。

  

在一堆Interceptor中，走到

com.atlassian.confluence.xwork.ConfluenceXsrfTokenInterceptor#intercept时，会继续调用他的父类com.atlassian.xwork.interceptors.XsrfTokenInterceptor#intercept。

  

![图片](assets/1700545045-a81eb14bcdfe858819256fcdd2f0acac.png)

![图片](assets/1700545045-da57e4973d1b8fd88f13bf54b5c91cf6.png)

  

这里会调用methodRequiresProtection来得到isProtected，我们获取到的validToken为空，如果isProtected为True，则会返回input。

  

只有isProtected取到false，才能继续调用invoke，走入下一个intercept，最终走进com.atlassian.confluence.importexport.actions.SetupRestoreAction#execute。

  

![图片](assets/1700545045-c9ac22249907e579b032a3c5e972404e.png)

  

这里继续跟进isOverrideHeaderPresent。

  

![图片](assets/1700545045-e5de3ecfd8b6ad9794e9f0cf1166d0b4.png)

  

只要设置请求头X-Atlassian-Token: no-check即可。

  

  

  

  

****3\. holderAware.validate验证****

  

  

在进入SetupRestoreAction#execute之前，会有一个Interceptor调用对应Action类的validate方法，以验证请求是否正常。

  

对应的位置com.atlassian.confluence.core.ConfluenceWorkflowInterceptor#intercept

之后会进入com.atlassian.confluence.importexport.actions.SetupRestoreAction#validate方法。

  

![图片](assets/1700545045-24bc6a5ae5cd2a037048d7db23d6cc29.png)

  

这里会先把表单中的文件存到一个临时目录下，接着会判断他的内容是否是一个备份文件，只有检查都通过才会最后进入execute。

  

![图片](assets/1700545045-5f766e2591a4d81aa1735d75f04511d4.png)

  

可以看一下上传临时文件的代码。

  

![图片](assets/1700545045-0d429769d506b21ea435f9a271317237.png)

  

FileUploadUtils.getSingleUploadedFile会获取文件名，并生成一个随机的目录名，此时文件还没上传。

  

![图片](assets/1700545045-279abd8fb127fa016ae4e8c36ebcd2fa.png)

  

然后进入moveUploadedFile开始写文件。

  

![图片](assets/1700545045-b03684e06f8e7b8aec4589d27a4e9bf4.png)

  

这里上传的路径是用File构造的，无法进行目录穿越

下一步的ExportDescriptor.getExportDescriptor(upload).getScope()的操作应该是用来解压压缩包，并获取某些数据。

  

![图片](assets/1700545045-b7b2a8b27d679b80deecdb329e610df0.png)

  

继续跟进。

  

![图片](assets/1700545045-0aae15e03710d79f32bd6504d130f68f.png)

  

继续跟进readExportDescriptor。

  

![图片](assets/1700545045-f17ec924f7a72c1f1bdf860570b1f312.png)

  

这里unzipper.unzipFileInArchive("exportDescriptor.properties")只会解压出来

exportDescriptor.properties这个文件，最后再删除临时目录。

  

![图片](assets/1700545045-cfb05d87f4efd70f3fca21532779799c.png)

  

在解压的时候，这里会判断解压的目录是不是原先规定目录的子集，其实在这里无法进行目录穿越。

  

  

  

****4\. SetupRestoreAction处理逻辑****

  

  

这里只接受POST请求，RequireSecurityToken为True。

  

![图片](assets/1700545045-3cb2d2019729d200ee519473100e5876.png)

  

先调用父类的execute，如果返回的值为True，就会进入恢复安装步骤，拿到管理员权限。  

  

我们先跟进super.execute，位于

com.atlassian.confluence.importexport.actions.RestoreAction#execute。

  

![图片](assets/1700545045-79eaf5c978c6bb8c8b0c48457ca3db00.png)

  

里面继续调用super.execute，再进入

com.atlassian.confluence.importexport.actions.AbstractImportAction#execute。

  

![图片](assets/1700545045-39324028a4090891ba1da1c2ca7fc736.png)

  

如果允许导入，就开始执行doRestore，跟进看看。

  

![图片](assets/1700545045-492f33959d08f9a2b456a15e9e0c47e5.png)

  

我们传参的时候需要传入Synchronous=true，否则他会放入队列中，返回一个taskId，之后再异步执行。

  

![图片](assets/1700545045-f1c41874791cfa5521c7dc18e548d96d.png)

  

如果异步执行，返回包会进行302跳转。

  

![图片](assets/1700545045-7af67207af5bc7a2c91d824469657e8c.png)

  

在第一个Interceptor就会被拦

com.atlassian.confluence.setup.actions.SetupCheckInterceptor#intercept。

  

![图片](assets/1700545045-dc90d9233c2ffeaba6751932f8787ee5.png)

  

参考CVE-2023-22515，最新版本中无法设置这几个和安装有关的属性，无法绕过。

  

**三、漏洞利用**

  

  

上传备份文件后，覆盖目标数据，从而拿到后台权限。  

  

后续可以在管理应用的地方上传恶意jar包插件来进行rce。

  

可以参考：

https://github.com/youcannotseemeagain/CVE-2023-22515\_RCE

  

![图片](assets/1700545045-fbe49c4b87637dfad87ba36641477bb8.png)
