

# ç°¡å–®åˆ†æ CVE-2023-46729ï¼šSentry Next.js SDK çš„ URL rewrite æ¼æ´ - Huli's blog

# ç°¡å–®åˆ†æ CVE-2023-46729ï¼šSentry Next.js SDK çš„ URL rewrite æ¼æ´

ğŸ”„Â Â â“

2023å¹´11æœˆ13æ—¥ [Security](https://blog.huli.tw/categories/Security/)

ğŸ”„Â Â â“

Sentry åœ¨ 2023 å¹´ 11 æœˆ 9 è™Ÿæ™‚ï¼Œåœ¨éƒ¨è½æ ¼ä¸Šç™¼å¸ƒäº†é€™ç¯‡æ–‡ç« ï¼š[Next.js SDK Security Advisory - CVE-2023-46729](https://blog.sentry.io/next-js-sdk-security-advisory-cve-2023-46729/)ï¼Œå…§å®¹ä¸»è¦åœ¨è¬›è¿° CVE-2023-46729 é€™å€‹æ¼æ´çš„ä¸€äº›ç´°ç¯€ï¼ŒåŒ…å«æ¼æ´æˆå› ã€ç™¼ç¾æ™‚é–“ä»¥åŠä¿®è£œæ™‚é–“ç­‰ç­‰ã€‚

ğŸ”„Â Â â“

é›–ç„¶èªªæ˜¯åœ¨ 11/9 æ­£å¼å°å¤–ç™¼å¸ƒæ¼æ´å…¬å‘Šï¼Œä½†æ¼æ´å…¶å¯¦åœ¨ 10/31 ç™¼ä½ˆçš„ 7.77.0 ç‰ˆæœ¬å·²ç¶“ä¿®å¾©äº†ï¼Œæœ‰é ç•™ä¸€äº›æ™‚é–“çµ¦é–‹ç™¼è€…å€‘ä¾†ä¿®è£œæ¼æ´ã€‚

ğŸ”„Â Â â“

æ¥è‘—å°±ä¾†ç°¡å–®è¬›ä¸€ä¸‹é€™å€‹æ¼æ´çš„æˆå› ä»¥åŠæ”»æ“Šæ–¹å¼ã€‚

ğŸ”„Â Â â“

## æ¼æ´åˆ†æ

åœ¨ GitHub ä¸Šé¢ä¹Ÿæœ‰ä¸€å€‹æ¯”è¼ƒåæŠ€è¡“çš„èªªæ˜ï¼š[CVE-2023-46729: SSRF via Next.js SDK tunnel endpoint](https://github.com/getsentry/sentry-javascript/security/advisories/GHSA-2rmr-xw8m-22q9)

ğŸ”„Â Â â“

å¯ä»¥çœ‹åˆ°é€™ä¸€æ®µï¼š

ğŸ”„Â Â â“

> An unsanitized input of Next.js SDK tunnel endpoint allows sending HTTP requests to arbitrary URLs and reflecting the response back to the user.
> 
> ğŸ”„Â Â â“

åœ¨ Sentry è£¡é¢ï¼Œæœ‰ä¸€å€‹å«åš tunnel çš„åŠŸèƒ½ï¼Œé€™å¼µä¾†è‡ªæ–¼[å®˜æ–¹æ–‡ä»¶](https://docs.sentry.io/platforms/javascript/troubleshooting/#dealing-with-ad-blockers)çš„åœ–å®Œç¾åœ°è§£é‡‹äº†ç‚ºä»€éº¼éœ€è¦ tunnelï¼š

ğŸ”„Â Â â“

[![tunnel](assets/1699940897-8ccd91376d324c48ee4fe923c284f380.png)](https://blog.huli.tw/img/sentry-nextjs-sdk-cve-2023-46729/p1.png)

å¦‚æœæ²’æœ‰ tunnel çš„è©±ï¼Œé€çµ¦ Sentry çš„è«‹æ±‚æœƒåœ¨å‰ç«¯ç›´æ¥é€éç€è¦½å™¨ç™¼é€ï¼Œè€Œé€™äº›ç›´æ¥ç™¼çµ¦ Sentry çš„è«‹æ±‚å¯èƒ½æœƒè¢«ä¸€äº› ad blocker æ“‹ä½ï¼ŒSentry å°±æ²’è¾¦æ³•æ¥æ”¶åˆ°æ•¸æ“šã€‚è‹¥æ˜¯æœ‰é–‹å•Ÿ tunnelï¼Œå°±æœƒè®Šæˆå…ˆå°‡è«‹æ±‚ç™¼é€çµ¦è‡ªå·±çš„ serverï¼Œå†å¾è‡ªå·±çš„ server è½‰ç™¼çµ¦ Sentryï¼Œé€™æ¨£å°±è®Šæˆäº† same-origin çš„è«‹æ±‚ï¼Œä¾¿ä¸æœƒè¢« ad blocker æ“‹ä½ã€‚

ğŸ”„Â Â â“

åœ¨å°ˆé–€æä¾›çµ¦ Next.js ä½¿ç”¨çš„ Sentry SDK ä¸­ï¼Œæ˜¯ç”¨äº†ä¸€å€‹å«åš [rewrite](https://nextjs.org/docs/app/api-reference/next-config-js/rewrites) çš„åŠŸèƒ½ï¼Œå®˜æ–¹ç¯„ä¾‹å¦‚ä¸‹ï¼š

ğŸ”„Â Â â“

```javascript
module.exports = {
  async rewrites() {
    return [
      {
        source: '/blog',
        destination: 'https://example.com/blog',
      },
      {
        source: '/blog/:slug',
        destination: 'https://example.com/blog/:slug', // Matched parameters can be used in the destination
      },
    ]
  },
}
```

Next.js çš„ rewrite åŸºæœ¬ä¸Šå¯ä»¥åˆ†ç‚ºå…©ç¨®ï¼Œinternal è·Ÿ externalï¼Œå¾Œè€…çš„è©±å…¶å¯¦æ›´åƒæ˜¯ proxy çš„æ„Ÿè¦ºï¼Œå¯ä»¥ç›´æ¥æŠŠè«‹æ±‚å°å‘åˆ°å¤–éƒ¨ç¶²ç«™ï¼Œç„¶å¾Œé¡¯ç¤ºå‡º responseã€‚

ğŸ”„Â Â â“

Next.js Sentry SDK çš„å¯¦ä½œåœ¨ [sentry-javascript/packages/nextjs/src/config/withSentryConfig.ts](https://github.com/getsentry/sentry-javascript/blob/7.69.0/packages/nextjs/src/config/withSentryConfig.ts#L98)ï¼š

ğŸ”„Â Â â“

```javascript
/**
 * Injects rewrite rules into the Next.js config provided by the user to tunnel
 * requests from the `tunnelPath` to Sentry.
 *
 * See https://nextjs.org/docs/api-reference/next.config.js/rewrites.
 */
function setUpTunnelRewriteRules(userNextConfig: NextConfigObject, tunnelPath: string): void {
  const originalRewrites = userNextConfig.rewrites;

  // This function doesn't take any arguments at the time of writing but we future-proof
  // here in case Next.js ever decides to pass some
  userNextConfig.rewrites = async (...args: unknown[]) => {
    const injectedRewrite = {
      // Matched rewrite routes will look like the following: `[tunnelPath]?o=[orgid]&p=[projectid]`
      // Nextjs will automatically convert `source` into a regex for us
      source: `${tunnelPath}(/?)`,
      has: [
        {
          type: 'query',
          key: 'o', // short for orgId - we keep it short so matching is harder for ad-blockers
          value: '(?<orgid>.*)',
        },
        {
          type: 'query',
          key: 'p', // short for projectId - we keep it short so matching is harder for ad-blockers
          value: '(?<projectid>.*)',
        },
      ],
      destination: 'https://o:orgid.ingest.sentry.io/api/:projectid/envelope/?hsts=0',
    };

    if (typeof originalRewrites !== 'function') {
      return [injectedRewrite];
    }

    // @ts-expect-error Expected 0 arguments but got 1 - this is from the future-proofing mentioned above, so we don't care about it
    const originalRewritesResult = await originalRewrites(...args);

    if (Array.isArray(originalRewritesResult)) {
      return [injectedRewrite, ...originalRewritesResult];
    } else {
      return {
        ...originalRewritesResult,
        beforeFiles: [injectedRewrite, ...(originalRewritesResult.beforeFiles || [])],
      };
    }
  };
}
```

å…¶ä¸­çš„é‡ä¸­ä¹‹é‡å°±æ˜¯é€™ä¸€æ®µï¼š

ğŸ”„Â Â â“

```javascript
const injectedRewrite = {
  // Matched rewrite routes will look like the following: `[tunnelPath]?o=[orgid]&p=[projectid]`
  // Nextjs will automatically convert `source` into a regex for us
  source: `${tunnelPath}(/?)`,
  has: [
    {
      type: 'query',
      key: 'o', // short for orgId - we keep it short so matching is harder for ad-blockers
      value: '(?<orgid>.*)',
    },
    {
      type: 'query',
      key: 'p', // short for projectId - we keep it short so matching is harder for ad-blockers
      value: '(?<projectid>.*)',
    },
  ],
  destination: 'https://o:orgid.ingest.sentry.io/api/:projectid/envelope/?hsts=0',
};
```

æœƒæ ¹æ“š query string ä¸­çš„ `o` è·Ÿ `p`ï¼Œæ±ºå®šæœ€å¾Œè¦é‡æ–°å°å‘çš„ URLã€‚

ğŸ”„Â Â â“

è€Œé€™é‚Šçš„å•é¡Œæ˜¯é€™å…©å€‹åƒæ•¸çš„ regexp éƒ½ç”¨äº† `.*`ï¼Œä¹Ÿå°±æ˜¯èªªæœƒé…å°åˆ°ä»»ä½•å­—å…ƒï¼Œæ›å¥è©±èªªï¼Œåº•ä¸‹é€™å€‹ç¶²å€ï¼š

ğŸ”„Â Â â“

```none
https://huli.tw/tunnel?o=abc&p=def
```

æœƒ proxy åˆ°ï¼š

ğŸ”„Â Â â“

```none
https://oabc.ingest.sentry.io/api/def/envelope/?hsts=0
```

çœ‹èµ·ä¾†æ²’ä»€éº¼å•é¡Œï¼Œä½†å¦‚æœæ˜¯é€™æ¨£å‘¢ï¼Ÿ

ğŸ”„Â Â â“

```none
https://huli.tw/tunnel?o=example.com%23&p=def
```

`%23` æ˜¯ `#` URL encode å¾Œçš„çµæœï¼Œæœ€å¾Œå°±æœƒ proxy åˆ°ï¼š

ğŸ”„Â Â â“

```none
https://oexample.com#.ingest.sentry.io/api/def/envelope/?hsts=0
```

æˆ‘å€‘åˆ©ç”¨äº† `#` ä¾†æŠŠåŸæœ¬çš„ hostname éƒ½ç•¶æˆ hash çš„ä¸€éƒ¨åˆ†ï¼Œä¸¦ä¸”æˆåŠŸæ›´æ”¹äº† proxy çš„ç›®çš„åœ°ã€‚ä½†æœ€å‰é¢é‚£å€‹ o é‚„æ˜¯æœ‰é»ç…©äººï¼Œä¸å¦‚æŠŠå®ƒä¸€èµ·æ¶ˆé™¤æ‰å§ï¼åªè¦åœ¨æœ€å‰é¢åŠ å€‹ `@` å°±è¡Œäº†ï¼š

ğŸ”„Â Â â“

```none
https://huli.tw/tunnel?o=@example.com%23&p=def
```

æœƒè®Šæˆï¼š

ğŸ”„Â Â â“

```none
https://o@example.com#.ingest.sentry.io/api/def/envelope/?hsts=0
```

å¦‚æ­¤ä¸€ä¾†ï¼Œæ”»æ“Šè€…å°±å¯ä»¥åˆ©ç”¨ o é€™å€‹åƒæ•¸æ›´æ”¹ proxy çš„ç›®çš„åœ°ï¼Œå°‡ request å°å‘è‡³ä»»ä½•åœ°æ–¹ã€‚å‰›å‰›æœ‰èªªéé€™å€‹ rewrite åŠŸèƒ½æœƒå°‡ response ç›´æ¥å›å‚³ï¼Œæ‰€ä»¥ç•¶ä½¿ç”¨è€…ç€è¦½ï¼š`https://huli.tw/tunnel?o=@example.com%23&p=def` çš„æ™‚å€™ï¼Œçœ‹åˆ°çš„ response æœƒæ˜¯ `example.com` çš„çµæœã€‚

ğŸ”„Â Â â“

ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœæ”»æ“Šè€…æŠŠè«‹æ±‚å°å‘è‡³è‡ªå·±çš„ç¶²ç«™ï¼Œå°±å¯ä»¥è¼¸å‡º `<script>alert(document.cookie)</script>`ï¼Œå°±è®Šæˆäº†ä¸€å€‹ XSS æ¼æ´ã€‚

ğŸ”„Â Â â“

è‹¥æ˜¯æ”»æ“Šè€…ä¸æ˜¯å°åˆ°è‡ªå·±çš„ç¶²ç«™ï¼Œè€Œæ˜¯å°å‘åˆ°å…¶ä»–å…§éƒ¨çš„ç¶²é å¦‚ `https://localhost:3001` ä¹‹é¡çš„ï¼Œå°±æ˜¯ä¸€å€‹ SSRF çš„æ¼æ´ï¼ˆä½†ç›®æ¨™å¿…é ˆæ”¯æ´ HTTPS å°±æ˜¯äº†ï¼‰ã€‚

ğŸ”„Â Â â“

è‡³æ–¼ä¿®å¾©æ–¹å¼çš„è©±ä¹Ÿå¾ˆç°¡å–®ï¼Œåªè¦å° regexp åšå‡ºä¸€äº›é™åˆ¶å³å¯ï¼Œæœ€å¾Œ Sentry æ˜¯èª¿æ•´æˆ[åªå…è¨±æ•¸å­—](https://github.com/getsentry/sentry-javascript/pull/9416/files)ï¼š

ğŸ”„Â Â â“

```javascript
{
  type: 'query',
  key: 'o', // short for orgId - we keep it short so matching is harder for ad-blockers
  value: '(?<orgid>\\d*)',
},
```

7.77.0 ç‰ˆæœ¬ä»¥åŠä¹‹å¾Œçš„ç‰ˆæœ¬éƒ½å·²ç¶“ä¿®å¾©äº†é€™å€‹å•é¡Œã€‚

ğŸ”„Â Â â“

## ç¸½çµ

ğŸ”„Â Â â“

é€™å€‹æ¼æ´çœŸçš„æ»¿ç°¡å–®è€Œä¸”æ»¿å¥½é‡ç¾çš„ï¼Œåªéœ€è¦æ‰¾åˆ°ä¿®å¾©çš„ commitï¼Œçœ‹å…©çœ¼ç¨‹å¼ç¢¼å¤§æ¦‚å°±èƒ½çŸ¥é“æ€éº¼æ”»æ“Šã€‚

ğŸ”„Â Â â“

ç¸½ä¹‹å‘¢ï¼Œåœ¨åš URL rewrite çš„æ™‚å€™çœŸçš„å¿…é ˆè¬¹æ…ä¸€é»ï¼Œä¸ç„¶é‚„æ»¿å®¹æ˜“å‡ºå•é¡Œçš„ï¼ˆå°¤å…¶æ˜¯ä½ ä¸åªæ˜¯ rewrite pathï¼Œè€Œæ˜¯ rewrite æ•´å€‹ URLï¼‰ã€‚

ğŸ”„Â Â â“

[#Security](https://blog.huli.tw/tags/Security/)

[HITCON CTF 2023 èˆ‡ SECCON CTF 2023 ç­†è¨˜](https://blog.huli.tw/2023/09/23/hitcon-seccon-ctf-2023-writeup/)

ğŸ”„Â Â â“
