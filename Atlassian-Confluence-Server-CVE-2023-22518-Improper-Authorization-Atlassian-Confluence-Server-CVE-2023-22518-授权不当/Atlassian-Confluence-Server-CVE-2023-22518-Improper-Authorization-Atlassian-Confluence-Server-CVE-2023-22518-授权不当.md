

# Atlassian Confluence Server (CVE-2023-22518) - Improper Authorization --- Atlassian Confluence Server （CVE-2023-22518） - 授权不当

[CVE-2023-22518](https://confluence.atlassian.com/security/cve-2023-22518-improper-authorization-vulnerability-in-confluence-data-center-and-server-1311473907.html?ref=blog.projectdiscovery.io) is a critical vulnerability in [Atlassian Confluence](https://www.atlassian.com/software/confluence?ref=blog.projectdiscovery.io) Data Center and Server. The vulnerability could potentially allow unauthenticated attackers with network access to the Confluence Instance to restore the database of the Confluence instance and eventually execute arbitrary system commands.  
CVE-2023-22518 是 Atlassian Confluence Data Center and Server 中的一个严重漏洞。该漏洞可能允许对 Confluence 实例具有网络访问权限的未经身份验证的攻击者恢复 Confluence 实例的数据库并最终执行任意系统命令。

## Technical Details 技术细节

After performing a [patch diff](https://git-scm.com/docs/git-diff?ref=blog.projectdiscovery.io) between the patched and unpatched versions, we identified the addition of two new annotations, namely, `@WebSudoRequired` and `@SystemAdminOnly`, in various Action classes.  
在已修补版本和未修补版本之间执行补丁差异后，我们发现在各种 Action 类中添加了两个新注解，即 `@WebSudoRequired` 和 `@SystemAdminOnly` 。

Initially, we attempted to brute-force the routes leading to these specific actions, but this approach yielded no success. We then turned our attention to the `struts.xml` file, which contains information about action and namespace-based routing, as well as interceptors, hoping to uncover insights. However, nothing immediately stood out.  
最初，我们试图暴力破解导致这些特定操作的路由，但这种方法没有成功。然后，我们将注意力转向该文件 `struts.xml` ，其中包含有关操作和基于命名空间的路由以及拦截器的信息，希望能发现见解。然而，没有什么立即脱颖而出。

Additionally, we noticed a regex change in the `SafeParametersInterceptor`, which was related to a previous critical [CVE-2023-22515](https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-289a?ref=blog.projectdiscovery.io) that had led to authentication bypass. We dedicated a significant amount of time trying to exploit this change, but were unable to make any breakthroughs. Our investigation led us to the understanding that in the case of `ActionObject.getXYZ.getABC[N]=ANYTHING`, where `N` must be a digit, the `SafeParametersInterceptor` would not consider the parameter key as a complex parameter and would permit `OgnlValueStack.setValue(...)`.  
此外，我们注意到 `SafeParametersInterceptor` 中的正则表达式更改，这与之前导致身份验证绕过的关键 CVE-2023-22515 有关。我们投入了大量时间试图利用这一变化，但未能取得任何突破。我们的调查使我们了解到 `ActionObject.getXYZ.getABC[N]=ANYTHING` ，在 的情况下，其中 `N` 必须是数字，不会 `SafeParametersInterceptor` 将参数键视为复参数，并且允许 `OgnlValueStack.setValue(...)` 。

The discovery revealed a complex hurdle: locating a method capable of facilitating authentication bypass through property modifications. This process necessitated the existence of a getter returning a collection or array. Furthermore, an index with a manipulable setter was essential. We then redirected our focus to the struts.xml file, scrutinizing its contents for any potential leads. Upon closer inspection, it was evident that the `/json` namespace enhances the `/admin` namespace's functions. Consequently, routes crafted for the `/admin` namespace can also be accessed via the `/json` namespace.  
这一发现揭示了一个复杂的障碍：找到一种能够通过属性修改来促进身份验证绕过的方法。这个过程需要存在一个返回集合或数组的 getter。此外，具有可操纵的 setter 的索引也是必不可少的。然后，我们将注意力转移到struts.xml文件，仔细检查其内容以查找任何潜在的潜在客户。经过仔细检查，很明显命名空间增强了 `/admin` 命名空间 `/json` 的功能。因此，也可以通过命名空间访问为 `/admin` `/json` 命名空间创建的路由。

In the context of the `/json` namespace, the request routing process involves passing through a series of interceptors. One of these interceptors, known as the `WebSudoInterceptor`, performs checks based on the request URI.  
在命名空间的上下文中 `/json` ，请求路由过程涉及通过一系列侦听器。其中一个拦截器（称为 `WebSudoInterceptor` ）根据请求 URI 执行检查。

WebSudo, a security feature commonly associated with Atlassian Confluence, plays a crucial role here. It requires users to re-authenticate themselves with elevated privileges, typically their password, before they can perform critical operations.  
WebSudo 是通常与 Atlassian Confluence 相关的安全功能，在这里起着至关重要的作用。它要求用户在执行关键操作之前，使用提升的权限（通常是其密码）重新对自己进行身份验证。

Specifically, the WebSudoInterceptor performs the following checks:  
具体而言，WebSudoInterceptor 执行以下检查：

1.  If the request path is `/authenticate.action`, it is skipped.  
    如果请求路径为 `/authenticate.action` ，则跳过该路径。
2.  If the request path is `/admin`, it checks whether the `WebSudoNotRequired` attribute is not null.  
    如果请求路径为 ，则检查该 `WebSudoNotRequired` 属性是否不为 `/admin` null。
3.  For any other request path, such as those in the `/json` namespace, it ensures that the `WebSudoRequired` attribute is null. This condition suggests that the `WebSudoRequired` annotation is not present at either the class, package, or method level. If this condition is met, the WebSudo check, which is responsible for initiating a secure admin session, is skipped.  
    对于任何其他请求路径（例如命名空间中的 `/json` 请求路径），它确保该 `WebSudoRequired` 属性为 null。这种情况表明 `WebSudoRequired` 注释在类、包或方法级别都不存在。如果满足此条件，则跳过负责启动安全管理会话的 WebSudo 检查。

The objective now is to identify an action (class) that lacks any authorization or authentication checks at the HTTP handler method level.  
现在的目标是识别在 HTTP 处理程序方法级别缺少任何授权或身份验证检查的操作（类）。

The subsequent phase involved conducting a brute-force of all the endpoints/actions within the `/admin/` namespace to `/json/`. The objective was to monitor the responses and identify any noteworthy findings. During this, an observation was made when attempting a GET request on `/json/setup-restore.action`, which resulted in a 405 Method Not Allowed response. Further examination of the code confirmed that it lacked the WebSudoRequired annotation and did not implement any secondary authentication checks within the method handler. In essence, this meant that by supplying the correct parameters, the request could potentially succeed without requiring any form of authentication.  
随后的阶段涉及对 `/admin/` 命名空间内的所有端点/操作进行暴力破解 `/json/` 。目的是监测答复并确定任何值得注意的发现。在此期间，在尝试 上的 `/json/setup-restore.action` GET 请求时进行了观察，这导致了 405 Method Not Allowed 响应。对代码的进一步检查证实，它缺少 WebSudoRequired 批注，并且未在方法处理程序中实现任何辅助身份验证检查。从本质上讲，这意味着通过提供正确的参数，请求可能会在不需要任何形式的身份验证的情况下成功。

```http
POST /json/setup-restore.action?synchronous=true HTTP/1.1
Host: localhost:8090
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryT3yekvo0rGaL9QR7
X-Atlassian-Token: no-check
Content-Length: 277538

------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="buildIndex"

false
------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="file";filename="exploit-restore.zip"

ZIP_DATA
------WebKitFormBoundaryT3yekvo0rGaL9QR7
Content-Disposition: form-data; name="edit"

Upload and import
------WebKitFormBoundaryT3yekvo0rGaL9QR7--
```

HTTP HTTP协议

Copy

Interestingly, passing `synchronous=true` what actually worked for us. This was a simple change from `false` to `true` when the earlier request was not resulting in a successful restore, even when a task was created to restore.  
有趣的是，传递 `synchronous=true` 真正对我们有用的东西。这是一个简单的更改，从 `false` 早期请求未导致成功还原时， `true` 即使创建了要还原的任务也是如此。

## Nuclei Template 细胞核模板

Due to the nature of this vulnerability, to restore the state of Confluence instance to attacker-controlled data/users. We're releasing a detection-based template rather than a full exploit-based template for this CVE.  
由于此漏洞的性质，将 Confluence 实例的状态恢复到攻击者控制的数据/用户。我们将为此 CVE 发布基于检测的模板，而不是基于漏洞利用的完整模板。  

[↓↓↓](https://templates.nuclei.sh/public/CVE-2023-22518?ref=blog.projectdiscovery.io)  
  

ProjectDiscovery Cloud Platform  
ProjectDiscovery 云平台

Create, edit, generate, and scan templates using AI in one seamless experience with Nuclei.  
使用 AI 创建、编辑、生成和扫描模板，实现 Nuclei 的无缝体验。

![](assets/1699429588-7f8cc6ad9627621dea55b21469e521e6.svg)

![](assets/1699429588-e16e8adc4d604a1839fb15dd61e219e9.png)

  
  
[↑↑↑](https://templates.nuclei.sh/public/CVE-2023-22518?ref=blog.projectdiscovery.io)
