

# SSH ProxyCommand == unexpected code execution (CVE-2023-51385) | Vin01’s Blog --- SSH代理命令==意外代码执行（CVE-2023-51385）|Vin 01的博客

# SSH ProxyCommand == unexpected code execution (CVE-2023-51385)  
SSH代理命令==意外代码执行（CVE-2023-51385）

Dec 20, 2023  二〇二三年十二月二十日

## Summary 总结

SSH’s `ProxyCommand` is a feature quite widely used to proxy ssh connections by allowing to specify custom commands to be used to connect to the server. Arguments to this directive may contain tokens like `%h`, `%u` which refer to hostname and username respectively.  
SSH的 `ProxyCommand` 是一个广泛用于代理ssh连接的特性，它允许指定用于连接到服务器的自定义命令。这个指令的参数可能包含像 `%h` ， `%u` 这样的标记，它们分别引用主机名和用户名。

When coming from untrusted sources, a hostname can be malicious and look something like **\`malicious-command\`** (backticks would allow a command to be executed in shell)  
当来自不受信任的来源时，主机名可能是恶意的，看起来像\`malicious-command\`（反引号将允许在shell中执行命令）

[↓↓↓](https://man.openbsd.org/ssh_config#ProxyCommand)  
  
More info in docs which describe this feature in detail  
详细描述此功能的文档中有更多信息  
  
[↑↑↑](https://man.openbsd.org/ssh_config#ProxyCommand)

## Let’s review an example  
让我们回顾一个示例

Taking an example based on the [docs](https://man.openbsd.org/ssh_config#ProxyCommand)  
以文档为例，

```plaintext
Host *.example.com
  ProxyCommand /usr/bin/nc -X connect -x 192.0.2.0:8080 %h %p
```

In this case, there is no sanitization of hostname and if `%h` contains a malicious hostname, it may allow command execution.  
在这种情况下，没有主机名的清理，如果 `%h` 包含恶意主机名，它可能允许命令执行。

## Can I haz PoC?  
我能和你谈谈吗？

What good is all this without a PoC? So here we go! Once you have added the above example to your `.ssh/config`, try following which should pop a calculator on OS X.  
如果没有一个保镖，这一切有什么用？我们开始吧！一旦你把上面的例子添加到你的 `.ssh/config` 中，试着按照下面的步骤在OS X上弹出一个计算器。

```plaintext
git clone https://github.com/vin01/poc-proxycommand-vulnerable --recurse-submodules
```

Even if the ProxyCommand is being used with single quotes to sanitize arguments i.e. '%h', it is not sufficient since an attacker controlled hostname might itself contain a single quote and defeat quoting.  
即使ProxyCommand与单引号一起使用来清理参数（即“% h”），这也是不够的，因为攻击者控制的主机名本身可能包含单引号和无效引号。

PoC 2: 概念验证2：

```plaintext
git clone https://github.com/vin01/poc-proxycommand-vulnerable-v2 --recurse-submodules
```

## Remediation 整治

Update to: 更新为：

-   [↓↓↓](https://www.openssh.com/txt/release-9.6)  
      
    OpenSSH 9.6p1  OpenSSH 9.6p1标准版  
      
    [↑↑↑](https://www.openssh.com/txt/release-9.6)
    
-   [↓↓↓](https://www.libssh.org/security/advisories/CVE-2023-6004.txt)  
      
    libssh 0.10.6 and 0.9.8  
    libssh 0.10.6和0.9.8版本  
      
    [↑↑↑](https://www.libssh.org/security/advisories/CVE-2023-6004.txt)
    

## Vulnerable usage out in the wild  
在野外易受攻击的使用

-   [https://help.okta.com/asa/en-us/content/topics/adv\_server\_access/docs/custom-ssh-client.htm](https://help.okta.com/asa/en-us/content/topics/adv_server_access/docs/custom-ssh-client.htm)
-   [https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/use-cases/ssh/](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/use-cases/ssh/)
-   [https://cloud.google.com/iap/docs/tcp-by-host](https://cloud.google.com/iap/docs/tcp-by-host)
-   [https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html)
-   [https://goteleport.com/docs/connect-your-client/tsh/](https://goteleport.com/docs/connect-your-client/tsh/)
-   [https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies\_and\_Jump\_Hosts#Tunneling\_the\_SSH\_Client\_Over\_Tor\_with\_Netcat](https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts#Tunneling_the_SSH_Client_Over_Tor_with_Netcat)

## CVEs and references CVE和参考文献

-   [↓↓↓](https://nvd.nist.gov/vuln/detail/CVE-2023-51385)  
      
    CVE-2023-51385  中国生物医学工程学会  
      
    [↑↑↑](https://nvd.nist.gov/vuln/detail/CVE-2023-51385)
    
-   [↓↓↓](https://access.redhat.com/security/cve/cve-2023-6004)  
      
    CVE-2023-6004  中国生物医学工程学会  
      
    [↑↑↑](https://access.redhat.com/security/cve/cve-2023-6004)
    

## My sincere thanks to:  
我诚恳的道谢：

-   Kevin Roh @ Okta for brilliant triaging and impact assessment  
    Kevin Roh @ Okta出色的分类和影响评估
-   Jakub Jelen @ libssh for timely follow up and communication  
    Jakub Jelen @ libssh，以便及时跟进和沟通
-   Damien Miller and others @ Openssh for patches and discussions  
    Damien米勒和其他人@ Openssh获取补丁和讨论
-   Maintainers @ Git for discussions to define a potential trust boundary between ssh and git  
    Maintainers @ Git讨论如何定义ssh和git之间的潜在信任边界

**[↓↓↓](https://www.openbsd.org/donations.html)  
  
How to donate to OpenSSH/OpenBSD  
如何捐赠给OpenSSH/OpenBSD  
  
[↑↑↑](https://www.openbsd.org/donations.html)**
